<!doctype html>
<html lang='pt-BR'>

<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1' />
    <title>Semana 9 ‚Äî Seguran√ßa com Firebase Security Rules</title>
    <link rel='stylesheet' type='text/css' href='../css/style.css' />
</head>

<body>
    <div class='container'>

        <header>
            <h1 id='sem9'>SEMANA 9 ‚Äì Seguran√ßa com Firebase Security Rules</h1>
            <p class='lead'>Nesta semana, voc√™ ir√° configurar as regras de seguran√ßa (Security Rules)
                do Firestore para proteger os dados do seu app, garantindo que cada usu√°rio acesse
                apenas seus pr√≥prios registros.</p>
        </header>
        <hr />

        <p>Na <strong>Semana 5</strong> voc√™ criou o banco Firestore no <strong>modo de teste</strong>,
            permitindo leitura e escrita livres para facilitar o desenvolvimento. Na
            <strong>Semana 6</strong> voc√™ implementou a autentica√ß√£o e o CRUD. Agora √© o momento de
            <strong>ativar a seguran√ßa</strong>: configurar regras que garantam que cada usu√°rio
            autenticado acesse apenas seus pr√≥prios dados.
        </p>

        <table class="box-table tip-table">
            <tr>
                <td class="box-content tip" role="note" aria-labelledby="tip-s9-noauth">
                    <div id="tip-s9-noauth" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                            alt="Dica"><strong>Por que as regras n√£o foram configuradas antes?</strong></div>
                    <div>
                        <p>Nas Semanas 6 e 7, o CRUD foi testado com o Firestore em <strong>modo de
                                teste</strong> (sem restri√ß√µes). Isso permitiu validar os fluxos rapidamente
                            sem se preocupar com permiss√µes. Ao ativar as Security Rules agora, o app
                            passar√° a exigir autentica√ß√£o ‚Äî e cada query ser√° filtrada pelo
                            <code>usuarioRef</code> do documento.
                        </p>
                    </div>
                </td>
            </tr>
        </table>

        <table class="box-table tip-table">
            <tr>
                <td class="box-content tip" role="note" aria-labelledby="curiosity-s9">
                    <div id="curiosity-s9" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                            alt="Curiosidade"><strong>Voc√™ Sabia?</strong></div>
                    <div>
                        <ul>
                            <li>O Firebase utiliza <strong>Security Rules</strong> como mecanismo de
                                controle de acesso ‚Äî s√£o regras declarativas escritas em uma linguagem
                                pr√≥pria, avaliadas no servidor antes de cada leitura ou escrita.</li>
                            <li>O plano gratuito do Firebase (<strong>Spark</strong>) oferece at√©
                                <strong>1 GiB de armazenamento</strong> e autentica√ß√£o ilimitada ‚Äî
                                mais que suficiente para projetos acad√™micos.
                            </li>
                            <li>As Security Rules do Firebase s√£o similares em prop√≥sito ao
                                <strong>RLS (Row Level Security)</strong> do PostgreSQL ‚Äî ambos controlam
                                acesso a dados por usu√°rio.
                            </li>
                        </ul>
                        <p class="small" style="margin-top: 1em; color: #666; font-style: italic;">Fonte:
                            Firebase Documentation; Google Cloud Security.</p>
                    </div>
                </td>
            </tr>
        </table>

        <section id='sec9-1'>
            <h2>9.1 Firebase Security Rules ‚Äî Conceito</h2>
            <p>Com o CRUD funcionando e testado, chegou o momento de ativar a seguran√ßa
                do banco. As <strong>Firebase Security Rules</strong> s√£o regras escritas no console
                do Firebase que controlam quais documentos cada usu√°rio pode ler, criar, atualizar ou
                excluir. Sem elas, qualquer pessoa pode acessar ou modificar os dados do app.</p>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="def-s9-rules">
                        <div id="def-s9-rules" class="box-title"><img src="../images/icon-definicao.png"
                                class="icon-img" alt="Defini√ß√£o"><strong>Defini√ß√£o</strong></div>
                        <div>
                            <p><strong>Firebase Security Rules:</strong> mecanismo de seguran√ßa do Firestore
                                que permite controlar quais documentos cada usu√°rio pode acessar. As regras
                                s√£o escritas diretamente no console Firebase, usando a vari√°vel
                                <code>request.auth.uid</code> para identificar o usu√°rio autenticado e
                                <code>resource.data</code> para acessar os campos do documento.
                            </p>
                        </div>
                    </td>
                </tr>
            </table>

            <p>A <strong>Figura 9.1</strong> ilustra como as Security Rules atuam como um
                "porteiro" entre o app e o Firestore, verificando o token de autentica√ß√£o em
                cada requisi√ß√£o.</p>

            <figure class='figure'>
                <img src='../images/fig09_1_rls_auth.png'
                    alt='Fluxo de autentica√ß√£o e funcionamento das Security Rules no Firebase' class='figure-img' />
                <figcaption class='figure-caption'><strong>Figura 9.1 ‚Äî </strong>Fluxo de seguran√ßa: o Firebase
                    verifica o token de autentica√ß√£o e aplica as Security Rules antes de permitir qualquer
                    leitura ou escrita no Firestore.</figcaption>
            </figure>
        </section>

        <section id='sec9-2'>
            <h2>9.2 Escrevendo as Security Rules</h2>
            <p>As regras s√£o escritas no console do Firebase, em
                <strong>Firestore Database ‚Üí Regras</strong>. Veja o exemplo completo para o
                FinanCampus:
            </p>

            <figure class='listing'>
                <figcaption class='listing-title'><strong>C√≥digo 9.1 - </strong>Security Rules para o Firestore
                    do FinanCampus</figcaption>
                <pre class='code'>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Despesas: apenas o dono pode ler, criar, editar e excluir
    match /despesas/{despesaId} {
      allow read, update, delete: if request.auth != null
        && request.auth.uid == resource.data.usuarioRef;
      allow create: if request.auth != null;
    }

    // Receitas: mesma l√≥gica de despesas
    match /receitas/{receitaId} {
      allow read, update, delete: if request.auth != null
        && request.auth.uid == resource.data.usuarioRef;
      allow create: if request.auth != null;
    }

    // Perfis: apenas o dono pode ler e editar
    match /perfis/{perfilId} {
      allow read, update: if request.auth != null
        && request.auth.uid == resource.data.usuarioRef;
      allow create: if request.auth != null;
    }

    // Categorias: qualquer autenticado pode ler (s√£o compartilhadas)
    match /categorias/{categoriaId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas admin pode criar/editar
    }
  }
}
                </pre>
            </figure>

            <h3>Como aplicar as regras</h3>
            <ol>
                <li>No console Firebase, acesse <strong>Firestore Database ‚Üí Regras</strong>.</li>
                <li>Substitua o conte√∫do pelo c√≥digo acima (adaptado √†s suas cole√ß√µes).</li>
                <li>Clique em <strong>Publicar</strong>.</li>
                <li>Teste no app: tente acessar dados sem login ‚Üí deve retornar erro.</li>
                <li>Fa√ßa login e confirme que apenas os dados do usu√°rio logado s√£o exibidos.</li>
            </ol>

            <table class="box-table warning-table">
                <tr>
                    <td class="box-content warning" role="note" aria-labelledby="warn-s9-test">
                        <div id="warn-s9-test" class="box-title"><img src="../images/icon-importante.png"
                                class="icon-img" alt="Importante"><strong>Teste as regras!</strong></div>
                        <div>
                            <p>Ap√≥s publicar as regras, teste imediatamente no app. Se as queries
                                pararem de retornar dados, verifique:
                                (1) se o campo <code>usuarioRef</code> est√° sendo salvo corretamente nos
                                documentos (deve conter o <code>uid</code> do Firebase Auth);
                                (2) se a regra de <code>create</code> permite a cria√ß√£o quando o usu√°rio
                                est√° autenticado.</p>
                        </div>
                    </td>
                </tr>
            </table>
        </section>

        <section id='sec9-3'>
            <h2>9.3 Garantindo o Filtro por Usu√°rio no FlutterFlow</h2>
            <p>Com as Security Rules ativas, √© uma boa pr√°tica tamb√©m filtrar os dados
                <strong>no FlutterFlow</strong>, para evitar tentativas de leitura desnecess√°rias:
            </p>

            <ol>
                <li>Em cada <strong>Backend Query</strong> (Query Collection) que busca dados do
                    usu√°rio, adicione um filtro:
                    <code>usuarioRef == Authenticated User Reference</code>.
                </li>
                <li>Em cada <strong>Create Document</strong>, certifique-se de que o campo
                    <code>usuarioRef</code> √© preenchido com <strong>Authenticated User
                        Reference</strong> (valor autom√°tico do FlutterFlow).
                </li>
            </ol>

            <p>A <strong>Figura 9.2</strong> detalha o fluxo completo de verifica√ß√£o de sess√£o
                ao abrir o app, incluindo as configura√ß√µes de Entry Page e Logged In Page.</p>

            <figure class='figure'>
                <img src='../images/fig09_2_fluxo_auth.png'
                    alt='Fluxograma de autentica√ß√£o: verifica√ß√£o de sess√£o, Login ou Home' class='figure-img' />
                <figcaption class='figure-caption'><strong>Figura 9.2 ‚Äî </strong>Fluxo completo de autentica√ß√£o:
                    verifica√ß√£o de sess√£o na abertura do app, Login com Firebase Auth e redirecionamento
                    autom√°tico via Entry Page / Logged In Page.</figcaption>
            </figure>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="tip-s9-jwt">
                        <div id="tip-s9-jwt" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                                alt="Dica"><strong>Como funciona a sess√£o</strong></div>
                        <div>
                            <p>Ao fazer login, o Firebase Auth gera um <strong>token de
                                    autentica√ß√£o</strong> que identifica o usu√°rio. O FlutterFlow armazena
                                automaticamente esse token e o envia em cada requisi√ß√£o ao Firestore.
                                As Security Rules usam <code>request.auth.uid</code> para verificar se o
                                usu√°rio tem permiss√£o para acessar o documento.</p>
                        </div>
                    </td>
                </tr>
            </table>
        </section>

        <section id='sec9-4'>
            <h2>9.4 Entreg√°vel da Semana</h2>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="resumo-s9">
                        <div id="resumo-s9" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                                alt="Resumo"><strong>Resumo da Semana</strong></div>
                        <div>
                            <ul>
                                <li><strong>Security Rules configuradas</strong> e publicadas no Firestore
                                    para todas as cole√ß√µes.</li>
                                <li><strong>Filtros por usu√°rio</strong> adicionados em todas as Backend
                                    Queries do FlutterFlow.</li>
                                <li><strong>Teste de seguran√ßa:</strong> confirmar que dados de um
                                    usu√°rio n√£o s√£o vis√≠veis por outro.</li>
                                <li><strong>Screenshot</strong> ou v√≠deo das regras publicadas no console
                                    Firebase.</li>
                            </ul>
                        </div>
                    </td>
                </tr>
            </table>

            <p>Na pr√≥xima semana, voc√™ ir√° realizar os testes de integra√ß√£o completos do app,
                explorar o Realtime do Firestore e integrar APIs externas ao seu projeto.</p>
        </section>

        <section id='caso-sem9'>
            <h2>9.5 Estudo de Caso: FinanCampus</h2>
            <p>Veja como o grupo do <strong>FinanCampus</strong> configurou as Security Rules
                nesta semana.</p>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="caso-sem9-label">
                        <div id="caso-sem9-label" class="box-title"><img src="../images/icon-observacao.png"
                                class="icon-img" alt="Estudo de Caso"><strong>üì± Estudo de Caso ‚Äî Semana 9</strong>
                        </div>
                        <div>
                            <p><strong>Security Rules configuradas:</strong></p>
                            <ul>
                                <li><code>despesas</code>: leitura, edi√ß√£o e exclus√£o apenas pelo dono
                                    (<code>usuarioRef == request.auth.uid</code>).</li>
                                <li><code>receitas</code>: mesma l√≥gica de <code>despesas</code>.</li>
                                <li><code>perfis</code>: usu√°rio pode ver e editar apenas o pr√≥prio perfil.</li>
                                <li><code>categorias</code>: leitura liberada para todos os autenticados;
                                    escrita bloqueada (categorias s√£o pr√©-definidas nos seeds).</li>
                            </ul>
                            <p><strong>Filtros adicionados no FlutterFlow:</strong> todas as Backend
                                Queries filtradas por <code>usuarioRef == Authenticated User</code>.
                                Testado com 2 contas distintas ‚Äî cada uma v√™ apenas seus pr√≥prios dados.</p>
                        </div>
                    </td>
                </tr>
            </table>
        </section>

        <div class="page-foot">Prof. Rafael Vargas Mesquita ‚Äî Projeto Integrador ‚Ä¢ Semana 9</div>

    </div>
</body>

</html>