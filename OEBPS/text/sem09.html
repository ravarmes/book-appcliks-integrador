<!doctype html>
<html lang='pt-BR'>

<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1' />
    <title>Semana 9 ‚Äî Autentica√ß√£o e Migra√ß√£o para Supabase</title>
    <link rel='stylesheet' type='text/css' href='../css/style.css' />
</head>

<body>
    <div class='container'>

        <header>
            <h1 id='sem9'>SEMANA 9 ‚Äì Seguran√ßa e Autentica√ß√£o com Supabase</h1>
            <p class='lead'>Nesta semana, voc√™ ir√° ativar as pol√≠ticas de seguran√ßa (RLS) no banco de
                dados Supabase criado na Semana 6 e implementar o sistema completo de autentica√ß√£o
                no FlutterFlow ‚Äî login, cadastro e logout de usu√°rios.</p>
        </header>
        <hr />

        <p>Na <strong>Semana 6</strong> voc√™ criou o projeto no Supabase, criou as tabelas e conectou
            o banco ao FlutterFlow. Naquela etapa, o RLS (Row Level Security) estava desabilitado para
            facilitar os testes de CRUD. Agora √© o momento de <strong>ativar a seguran√ßa</strong>:
            configurar pol√≠ticas que garantam que cada usu√°rio acesse apenas seus pr√≥prios dados, e
            implementar o fluxo de <strong>autentica√ß√£o</strong> (login e cadastro) no app.</p>

        <table class="box-table tip-table">
            <tr>
                <td class="box-content tip" role="note" aria-labelledby="tip-s9-noauth">
                    <div id="tip-s9-noauth" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                            alt="Dica"><strong>Como funcionaram os testes sem autentica√ß√£o</strong></div>
                    <div>
                        <p>Nas Semanas 6 e 7, o CRUD foi testado com o RLS <strong>desabilitado</strong>
                            e sem login implementado. Para isso, os seeds (dados de exemplo) foram inseridos
                            diretamente pelo painel do Supabase, e as Backend Queries n√£o usavam filtro por
                            usu√°rio. Ao ativar o RLS nesta semana, duas mudan√ßas ocorrer√£o:</p>
                        <ul>
                            <li>As queries que n√£o enviam o token JWT (usu√°rio n√£o logado) passar√£o a
                                retornar <strong>zero resultados</strong> ‚Äî comportamento correto e esperado.</li>
                            <li>As Actions de Insert/Update/Delete exigir√£o que <code>auth.uid()</code>
                                coincida com o <code>usuario_id</code> do registro ‚Äî por isso √© essencial
                                implementar o login <strong>antes</strong> de testar o app com o RLS ativo.</li>
                        </ul>
                    </div>
                </td>
            </tr>
        </table>

        <table class="box-table tip-table">
            <tr>
                <td class="box-content tip" role="note" aria-labelledby="curiosity-s9">
                    <div id="curiosity-s9" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                            alt="Curiosidade"><strong>Voc√™ Sabia?</strong></div>
                    <div>
                        <ul>
                            <li>O Supabase usa o <strong>PostgreSQL</strong>, o banco de dados relacional
                                open source mais avan√ßado do mundo, com mais de 35 anos de desenvolvimento.</li>
                            <li>O plano gratuito do Supabase oferece <strong>500 MB de banco de dados</strong>
                                e at√© <strong>50.000 usu√°rios autenticados por m√™s</strong> ‚Äî mais do que
                                suficiente para projetos acad√™micos.</li>
                            <li>A autentica√ß√£o JWT usada pelo Supabase √© o mesmo padr√£o adotado por
                                Google, GitHub e outras plataformas de grande escala.</li>
                        </ul>
                        <p class="small" style="margin-top: 1em; color: #666; font-style: italic;">Fonte:
                            Supabase Documentation; PostgreSQL.org.</p>
                    </div>
                </td>
            </tr>
        </table>

        <section id='sec9-1'>
            <h2>9.1 Ativando o RLS (Row Level Security)</h2>
            <p>Com o CRUD funcionando e testado (Semana 6), chegou o momento de ativar a seguran√ßa
                do banco. O <strong>RLS (Row Level Security)</strong> √© um mecanismo do PostgreSQL
                que controla quais linhas cada usu√°rio pode ler, inserir, atualizar ou excluir.
                Sem ele, qualquer usu√°rio autenticado poderia ver os dados de todos os outros.</p>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="def-s9-rls">
                        <div id="def-s9-rls" class="box-title"><img src="../images/icon-definicao.png" class="icon-img"
                                alt="Defini√ß√£o"><strong>Defini√ß√£o</strong></div>
                        <div>
                            <p><strong>Row Level Security (RLS):</strong> mecanismo de seguran√ßa do PostgreSQL
                                que permite controlar quais linhas cada usu√°rio pode ler, inserir, atualizar
                                ou excluir. No Supabase, as pol√≠ticas RLS s√£o definidas usando SQL ou o editor
                                visual de pol√≠ticas.</p>
                        </div>
                    </td>
                </tr>
            </table>

            <p>A <strong>Figura 9.1</strong> ilustra o fluxo completo de autentica√ß√£o com JWT e como
                o RLS usa o <code>auth.uid()</code> para filtrar os dados de cada usu√°rio no banco.</p>

            <figure class='figure'>
                <img src='../images/fig09_1_rls_auth.png'
                    alt='Fluxo de autentica√ß√£o JWT e funcionamento do RLS no Supabase' class='figure-img' />
                <figcaption class='figure-caption'><strong>Figura 9.1 ‚Äî </strong>Fluxo de autentica√ß√£o com JWT e
                    filtragem de dados via RLS (<code>auth.uid() = usuario_id</code>).</figcaption>
            </figure>

            <h3>Como ativar o RLS nas tabelas</h3>
            <ol>
                <li>No painel do Supabase, acesse <strong>Table Editor ‚Üí [nome da tabela]</strong>.</li>
                <li>Clique em <strong>RLS disabled ‚Üí Enable RLS</strong>.</li>
                <li>Acesse <strong>Authentication ‚Üí Policies ‚Üí New Policy</strong>.</li>
                <li>Crie pol√≠ticas para SELECT, INSERT, UPDATE e DELETE usando
                    <code>auth.uid() = usuario_id</code> como condi√ß√£o.
                </li>
                <li>Repita para todas as tabelas que cont√™m dados pessoais dos usu√°rios.</li>
            </ol>
        </section>

        <section id='sec9-2'>
            <h2>9.2 Exemplo de Pol√≠ticas RLS</h2>
            <p>Veja abaixo o SQL para criar as pol√≠ticas RLS completas na tabela
                <code>despesas</code>. O mesmo padr√£o deve ser aplicado √†s demais tabelas
                que armazenam dados do usu√°rio (<code>receitas</code>, <code>perfis</code>).
            </p>

            <figure class='listing'>
                <figcaption class='listing-title'><strong>C√≥digo 9.1 - </strong>Pol√≠ticas RLS b√°sicas para a tabela
                    despesas</figcaption>
                <pre class='code'>
-- Habilitar RLS na tabela
ALTER TABLE despesas ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica: usu√°rio s√≥ v√™ suas pr√≥prias despesas
CREATE POLICY "Usu√°rios veem suas despesas"
  ON despesas FOR SELECT
  USING (auth.uid() = usuario_id);

-- Pol√≠tica: usu√°rio s√≥ insere despesas suas
CREATE POLICY "Usu√°rios inserem suas despesas"
  ON despesas FOR INSERT
  WITH CHECK (auth.uid() = usuario_id);

-- Pol√≠tica: usu√°rio s√≥ atualiza suas despesas
CREATE POLICY "Usu√°rios atualizam suas despesas"
  ON despesas FOR UPDATE
  USING (auth.uid() = usuario_id);

-- Pol√≠tica: usu√°rio s√≥ exclui suas despesas
CREATE POLICY "Usu√°rios excluem suas despesas"
  ON despesas FOR DELETE
  USING (auth.uid() = usuario_id);
                </pre>
            </figure>
        </section>

        <section id='sec9-3'>
            <h2>9.3 Autentica√ß√£o com Supabase no FlutterFlow</h2>
            <p>O Supabase oferece autentica√ß√£o integrada com v√°rios provedores. Para este projeto,
                usaremos <strong>e-mail e senha</strong>.</p>

            <p>Uma parte cr√≠tica da autentica√ß√£o √© o <strong>fluxo da Splash Screen</strong>: ao abrir
                o app, ele verifica se existe uma sess√£o ativa (token JWT v√°lido). Se sim, vai
                diretamente para a Home. Se n√£o, vai para o Login. A <strong>Figura 9.2</strong>
                detalha esse fluxo completo, incluindo as Actions de <em>Navigate &amp; Remove All</em>
                que garantem que o usu√°rio n√£o consiga voltar para a tela de login ap√≥s autenticar.</p>

            <figure class='figure'>
                <img src='../images/fig09_2_fluxo_auth.png'
                    alt='Fluxograma de autentica√ß√£o: Splash Screen verifica sess√£o JWT, vai para Login ou Home com Navigate & Remove All'
                    class='figure-img' />
                <figcaption class='figure-caption'><strong>Figura 9.2 ‚Äî </strong>Fluxo completo de autentica√ß√£o:
                    verifica√ß√£o de sess√£o na Splash Screen, Login com Supabase Auth e redirecionamento via Navigate
                    &amp; Remove All.</figcaption>
            </figure>

            <h3>Configurando no FlutterFlow</h3>
            <ol>
                <li>No FlutterFlow, acesse <strong>Settings ‚Üí Supabase</strong>.</li>
                <li>Informe a <strong>Project URL</strong> e a <strong>API Key (anon)</strong>.</li>
                <li>Ative a op√ß√£o <strong>Use Supabase Auth</strong>.</li>
                <li>Implemente as telas de <strong>Login</strong> e <strong>Cadastro</strong> usando
                    as Actions de autentica√ß√£o do Supabase.</li>
            </ol>

            <h3>Actions de Autentica√ß√£o Dispon√≠veis</h3>
            <table class='content-table'>
                <caption><strong>Tabela 9.1 - </strong>Actions de autentica√ß√£o Supabase no FlutterFlow.</caption>
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Descri√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Sign Up (Email)</strong></td>
                        <td>Cria um novo usu√°rio com e-mail e senha</td>
                    </tr>
                    <tr>
                        <td><strong>Sign In (Email)</strong></td>
                        <td>Autentica um usu√°rio existente</td>
                    </tr>
                    <tr>
                        <td><strong>Sign Out</strong></td>
                        <td>Encerra a sess√£o do usu√°rio</td>
                    </tr>
                    <tr>
                        <td><strong>Reset Password</strong></td>
                        <td>Envia e-mail para redefinir a senha</td>
                    </tr>
                    <tr>
                        <td><strong>Update User</strong></td>
                        <td>Atualiza dados do perfil do usu√°rio autenticado</td>
                    </tr>
                </tbody>
            </table>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="tip-s9-jwt">
                        <div id="tip-s9-jwt" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                                alt="Dica"><strong>Como funciona o JWT</strong></div>
                        <div>
                            <p>Ao fazer login, o Supabase retorna um <strong>JWT (JSON Web Token)</strong>
                                ‚Äî um token criptografado que identifica o usu√°rio. O FlutterFlow armazena
                                automaticamente esse token e o envia em cada requisi√ß√£o ao banco. O Supabase
                                usa o <code>auth.uid()</code> nas pol√≠ticas RLS para filtrar os dados.</p>
                        </div>
                    </td>
                </tr>
            </table>
        </section>

        <section id='sec9-4'>
            <h2>9.4 Entreg√°vel da Semana</h2>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="resumo-s9">
                        <div id="resumo-s9" class="box-title"><img src="../images/icon-observacao.png" class="icon-img"
                                alt="Resumo"><strong>Resumo da Semana</strong></div>
                        <div>
                            <ul>
                                <li><strong>Projeto Supabase criado</strong> com as tabelas migradas.</li>
                                <li><strong>Pol√≠ticas RLS configuradas</strong> para todas as tabelas.</li>
                                <li><strong>Autentica√ß√£o funcionando</strong> no FlutterFlow (cadastro
                                    e login com e-mail/senha).</li>
                                <li><strong>Screenshot</strong> do painel do Supabase mostrando as
                                    tabelas e os primeiros registros.</li>
                            </ul>
                        </div>
                    </td>
                </tr>
            </table>

            <p>Na pr√≥xima semana, voc√™ ir√° realizar os testes de integra√ß√£o completos do app,
                explorar o Realtime do Supabase e integrar APIs externas ao seu projeto.</p>
        </section>

        <section id='caso-sem9'>
            <h2>9.5 Estudo de Caso: FinanCampus</h2>
            <p>Veja como o grupo do <strong>FinanCampus</strong> configurou o RLS e a autentica√ß√£o
                nesta semana (o projeto e as tabelas j√° haviam sido criados na Semana 6).</p>

            <table class="box-table tip-table">
                <tr>
                    <td class="box-content tip" role="note" aria-labelledby="caso-sem9-label">
                        <div id="caso-sem9-label" class="box-title"><img src="../images/icon-observacao.png"
                                class="icon-img" alt="Estudo de Caso"><strong>üì± Estudo de Caso ‚Äî Semana 9</strong>
                        </div>
                        <div>
                            <p><strong>RLS ativado em todas as tabelas:</strong></p>
                            <ul>
                                <li><code>despesas</code>: pol√≠ticas SELECT, INSERT, UPDATE e DELETE
                                    com condi√ß√£o <code>auth.uid() = usuario_id</code>.</li>
                                <li><code>receitas</code>: mesmas pol√≠ticas de <code>despesas</code>.</li>
                                <li><code>perfis</code>: usu√°rio pode ver e editar apenas o pr√≥prio perfil.</li>
                                <li><code>categorias</code>: SELECT p√∫blico (todos leem as categorias
                                    pr√©-definidas); INSERT restrito a service role.</li>
                            </ul>
                            <p><strong>Autentica√ß√£o implementada:</strong> telas de cadastro e login com
                                Supabase Auth (e-mail + senha). Token JWT armazenado automaticamente
                                pelo FlutterFlow. Trigger criado para inserir automaticamente na tabela
                                <code>perfis</code> quando um novo usu√°rio se cadastra.
                            </p>
                        </div>
                    </td>
                </tr>
            </table>
        </section>

        <div class="page-foot">Prof. Rafael Vargas Mesquita ‚Äî Projeto Integrador ‚Ä¢ Semana 9</div>

    </div>
</body>

</html>